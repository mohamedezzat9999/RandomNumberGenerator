name: Build and Test

on: [push, pull_request]

jobs:
  build:
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: password
          MYSQL_DATABASE: test
        ports:
          - 3306:3306

      activemq:
        image: rmohr/activemq:latest
        ports:
          - 61616:61616
          - 8161:8161
        env:
          ACTIVEMQ_ADMIN_LOGIN: admin
          ACTIVEMQ_ADMIN_PASSWORD: admin

      zookeeper:
        image: confluentinc/cp-zookeeper:latest
        ports:
          - 2181:2181
        env:
          ZOOKEEPER_CLIENT_PORT: 2181
          ZOOKEEPER_TICK_TIME: 2000

      kafka:
        image: confluentinc/cp-kafka:latest
        ports:
          - 9092:9092
        env:
          KAFKA_BROKER_ID: 1
          KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
          KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
          KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
          KAFKA_MESSAGE_MAX_BYTES: 20000000
          KAFKA_REPLICA_FETCH_MAX_BYTES: 20000000
        options: >-
          --health-cmd="kafka-broker-api-versions.sh --bootstrap-server localhost:9092"
          --health-interval=10s
          --health-timeout=60s
          --health-retries=10

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    - name: Wait for services to be healthy
      run: |
        sudo docker-compose up -d
        docker-compose ps
        until docker inspect -f '{{.State.Health.Status}}' kafka | grep -q "healthy"; do
          echo "Waiting for Kafka to be healthy..."
          sleep 10
        done

    - name: Build with Gradle
      run: ./gradlew build

    - name: Run tests with detailed logging
      run: ./gradlew test --info --stacktrace --scan
      env:
        SPRING_DATASOURCE_URL: jdbc:mysql://localhost:3306/test
        SPRING_DATASOURCE_USERNAME: root
        SPRING_DATASOURCE_PASSWORD: password
        SPRING_ACTIVEMQ_BROKER_URL: tcp://localhost:61616
        SPRING_KAFKA_BOOTSTRAP_SERVERS: localhost:9092
        SPRING_KAFKA_TOPIC: random-numbers
        SPRING_KAFKA_CONSUMER_GROUP_ID: group_id
        SPRING_KAFKA_CONSUMER_MAX_POLL_RECORDS: 500
        SPRING_KAFKA_CONSUMER_MAX_POLL_INTERVAL_MS: 20000000
        SPRING_KAFKA_CONSUMER_FETCH_MAX_BYTES: 20000000
        SPRING_KAFKA_MESSAGE_MAX_BYTES: 20000000
        SPRING_KAFKA_REPLICA_FETCH_MAX_BYTES: 20000000
